<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>PDF arrast√°vel + hitboxes (exemplo)</title>
<style>
  :root { --bg:#111; --fg:#eee; --controls-bg: rgba(0,0,0,0.6); }
  html,body { height:100%; margin:0; font-family:system-ui,Arial; background:var(--bg); color:var(--fg); }
  /* Controles */
  #controls {
    position:fixed; left:12px; top:12px; z-index:9999;
    background:var(--controls-bg); padding:8px; border-radius:8px; display:flex; gap:6px; align-items:center;
  }
  #controls button { background:transparent; color:var(--fg); border:1px solid rgba(255,255,255,0.08); padding:6px 8px; border-radius:6px; cursor:pointer; }
  #controls button:active { transform:translateY(1px); }
  #pageInfo { font-size:13px; opacity:0.9; margin-left:6px; }

  /* Viewer full-screen */
  #viewer { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; }
  #canvasContainer {
    position:relative;
    width:100%;
    height:100%;
    overflow:auto;           /* enable panning by scrolling */
    -webkit-overflow-scrolling: touch;
    touch-action: none;      /* we'll handle pointer pan */
    background: #222;
    display:flex; align-items:center; justify-content:center;
  }
  /* Canvas that shows the page */
  canvas#pdfCanvas { background:#fff; display:block; user-select:none; -webkit-user-drag:none; }

  /* Hitboxes */
  .hitbox {
    position:absolute;
    cursor:pointer;
    background:transparent; /* use semi-transparent for debugging: rgba(255,0,0,0.12) */
    border-radius:6px;
    z-index:50;
    transition:box-shadow .12s;
  }
  .hitbox:hover { box-shadow: 0 6px 18px rgba(0,0,0,0.35); }
  .hitbox[data-label]:hover::after{
    content: attr(data-label);
    position:absolute; left:0; top:-34px;
    background:rgba(0,0,0,0.8); color:#fff; padding:6px 8px; font-size:13px; border-radius:6px; white-space:nowrap;
  }

  /* mensagem de erro */
  #msg { position:fixed; right:12px; top:12px; z-index:9999; color:#f88; background:rgba(0,0,0,0.6); padding:8px 10px; border-radius:6px; display:none; }
</style>
</head>
<body>

<div id="controls">
  <button id="prev" title="P√°gina anterior">‚óÄ</button>
  <button id="next" title="Pr√≥xima p√°gina">‚ñ∂</button>
  <button id="zoomOut" title="Diminuir zoom">‚àí</button>
  <button id="zoomIn" title="Aumentar zoom">+</button>
  <button id="fit" title="Ajustar √† tela">üìê</button>
  <span id="pageInfo">Carregando‚Ä¶</span>
</div>

<div id="msg"></div>

<div id="viewer">
  <div id="canvasContainer">
    <canvas id="pdfCanvas"></canvas>
    <!-- hitboxes ser√£o inseridas dinamicamente aqui -->
  </div>
</div>

<!-- PDF.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.6.172/build/pdf.min.js"></script>
<script>
/* ========== CONFIGURA√á√ÉO ========== */
/* Substitua pelo seu PDF (pode ser caminho relativo ou URL). */
const pdfUrl = 'sample.pdf';

/* Hitboxes definidas por p√°gina.
   left, top, width, height em porcentagem (0-100)
   type: 'link' ou 'js'
   label: texto do tooltip
   href: para tipo link
   action: nome da fun√ß√£o para tipo js */
const hitboxesPerPage = {
  1: [
    { left: 8, top: 68, width: 22, height: 9, type: 'link', href: 'https://youtube.com', label: 'Abrir YouTube' },
    { left: 40, top: 28, width: 18, height: 12, type: 'js', action: 'acaoInternal', label: 'A√ß√£o interna' }
  ]
  // Se tiver mais p√°ginas: 2: [ ... ], 3: [ ... ]
};

/* ========== FIM CONFIG ========== */

const pdfjsLib = window['pdfjs-dist/build/pdf'];
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.6.172/build/pdf.worker.min.js';

const canvas = document.getElementById('pdfCanvas');
const container = document.getElementById('canvasContainer');
const ctx = canvas.getContext('2d');
const pageInfo = document.getElementById('pageInfo');
const msg = document.getElementById('msg');

let pdfDoc = null;
let pageNum = 1;
let scale = 1;          // escala atual (pixels)
let fitToScreen = true; // se true, ajusta inicialmente para caber na tela

/* ---------- Renderiza√ß√£o ---------- */
async function loadPdf() {
  try {
    pdfDoc = await pdfjsLib.getDocument(pdfUrl).promise;
    pageInfo.textContent = `P√°gina ${pageNum} / ${pdfDoc.numPages}`;
    await renderPage(pageNum);
  } catch (e) {
    console.error(e);
    showMsg('Erro ao carregar PDF. Verifique o nome do arquivo/CORS.');
  }
}

async function renderPage(num) {
  const page = await pdfDoc.getPage(num);
  const viewport = page.getViewport({ scale: 1 });

  // calcula escala para caber no container (mantendo propor√ß√£o)
  const cW = container.clientWidth || window.innerWidth;
  const cH = container.clientHeight || window.innerHeight;
  let targetScale = scale;
  if (fitToScreen) {
    const fitScale = Math.min(cW / viewport.width, cH / viewport.height);
    targetScale = fitScale;
  }

  // usa targetScale para renderizar a boa resolu√ß√£o
  const renderViewport = page.getViewport({ scale: targetScale });

  // ajusta canvas para resolu√ß√£o natural (pixels)
  canvas.width = Math.floor(renderViewport.width);
  canvas.height = Math.floor(renderViewport.height);

  // renderiza no contexto
  await page.render({ canvasContext: ctx, viewport: renderViewport }).promise;

  // CSS para responsividade: deixa canvas ocupar o espa√ßo do seu tamanho natural
  canvas.style.width = canvas.width + 'px';
  canvas.style.height = canvas.height + 'px';

  // atualiza escala guardada (se fitToScreen foi usado, grava esse scale)
  scale = targetScale;
  placeHitboxes(num);
  pageInfo.textContent = `P√°gina ${pageNum} / ${pdfDoc.numPages} ‚Äî zoom ${(scale*100).toFixed(0)}%`;
}

/* ---------- Hitboxes ---------- */
function clearHitboxes() {
  const prev = container.querySelectorAll('.hitbox');
  prev.forEach(n => n.remove());
}

let preventClick = false; // usado para ignorar cliques ap√≥s drag grande
function placeHitboxes(p) {
  clearHitboxes();
  const list = hitboxesPerPage[p] || [];
  list.forEach((h, idx) => {
    const el = (h.type === 'link') ? document.createElement('a') : document.createElement('div');
    el.className = 'hitbox';
    el.dataset.label = h.label || '';
    // usa porcentagem (relativa ao container)
    el.style.left = h.left + '%';
    el.style.top = h.top + '%';
    el.style.width = h.width + '%';
    el.style.height = h.height + '%';
    el.style.zIndex = 50;
    // se for link
    if (h.type === 'link') {
      el.href = h.href;
      el.target = '_blank';
      el.rel = 'noopener';
      el.addEventListener('click', (ev) => {
        if (preventClick) { ev.preventDefault(); ev.stopPropagation(); }
      });
    } else if (h.type === 'js') {
      el.addEventListener('click', (ev) => {
        if (preventClick) { ev.preventDefault(); ev.stopPropagation(); return; }
        // chama fun√ß√£o definida pelo nome (se existir)
        const fn = window[h.action];
        if (typeof fn === 'function') fn(h, ev);
        else console.warn('A√ß√£o JS n√£o encontrada:', h.action);
      });
    }
    container.appendChild(el);
  });
}

/* ---------- A√ß√µes de exemplo ---------- */
function acaoInternal() {
  alert('Executou a√ß√£o interna: abrir modal, preencher form, etc.');
}

/* ---------- Navega√ß√£o / Zoom ---------- */
document.getElementById('prev').addEventListener('click', ()=> {
  if (!pdfDoc) return;
  if (pageNum <= 1) return;
  pageNum--;
  fitToScreen = false;
  renderPage(pageNum);
});
document.getElementById('next').addEventListener('click', ()=> {
  if (!pdfDoc) return;
  if (pageNum >= pdfDoc.numPages) return;
  pageNum++;
  fitToScreen = false;
  renderPage(pageNum);
});
document.getElementById('zoomIn').addEventListener('click', ()=> {
  fitToScreen = false;
  scale = scale * 1.2;
  renderPage(pageNum);
});
document.getElementById('zoomOut').addEventListener('click', ()=> {
  fitToScreen = false;
  scale = scale / 1.2;
  renderPage(pageNum);
});
document.getElementById('fit').addEventListener('click', ()=> {
  fitToScreen = true;
  renderPage(pageNum);
});

/* ---------- Drag para pan (scroll by drag) - funciona com mouse e touch via pointer events ---------- */
let isPointerDown = false;
let startX=0, startY=0, scrollLeftStart=0, scrollTopStart=0;
let dragMoved = false;

container.addEventListener('pointerdown', (e) => {
  // queremos iniciar o arrastar apenas quando clicar fora de inputs, etc
  isPointerDown = true;
  container.setPointerCapture(e.pointerId);
  startX = e.clientX;
  startY = e.clientY;
  scrollLeftStart = container.scrollLeft;
  scrollTopStart = container.scrollTop;
  dragMoved = false;
});

container.addEventListener('pointermove', (e) => {
  if (!isPointerDown) return;
  const dx = e.clientX - startX;
  const dy = e.clientY - startY;
  if (Math.abs(dx) > 4 || Math.abs(dy) > 4) dragMoved = true;
  container.scrollLeft = scrollLeftStart - dx;
  container.scrollTop = scrollTopStart - dy;
});

container.addEventListener('pointerup', (e) => {
  if (isPointerDown) {
    isPointerDown = false;
    try { container.releasePointerCapture(e.pointerId); } catch(_) {}
    if (dragMoved) {
      preventClick = true;
      // limpa preventClick rapidamente (um clique subsequente ser√° ignorado)
      setTimeout(()=> preventClick = false, 50);
    }
  }
});

/* evita sele√ß√£o de texto ao arrastar */
container.addEventListener('dragstart', (e) => e.preventDefault());

/* ---------- Resize: re-render para recalcular escala/posi√ß√µes ---------- */
let resizeTimer = null;
window.addEventListener('resize', ()=> {
  if (!pdfDoc) return;
  clearTimeout(resizeTimer);
  resizeTimer = setTimeout(()=> renderPage(pageNum), 160);
});

/* ---------- Utils ---------- */
function showMsg(text, timeout=4000) {
  msg.textContent = text;
  msg.style.display = 'block';
  if (timeout>0) setTimeout(()=> msg.style.display='none', timeout);
}

/* ---------- Inicializa tudo ---------- */
loadPdf();
</script>
</body>
</html>
